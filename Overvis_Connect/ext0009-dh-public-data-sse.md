# EXT0009: DH Public Data for Shared Secret Exchange

* *Extension dependencies:* no
* *Document status:* `Approved on 2020-02-01`

This extension describes the process of exchanging public key parameters to obtain a public private key based on the Diffie-Hellman algorithm. This is necessary, for example, to establish an encrypted session in the future.

## Key exchange algorithm

Key exchange is carried out using the Diffie-Hellman algorithm.

Diffie-Hellman algorithm:
* https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange


# Commands (`CMD`)


## `0013` Public Data for New Shared Secret

This request passes parameters for calculating keys, as well as the public key of the client (application). In response, the server (device) sends its public key. After exchanging public keys, the client and server calculate the private key.

This request can be sent by the client at any time. If it is called during an encrypted session, subsequent requests/responses should be encrypted with a new key (the old key is forgotten after answering this request).

### Request

```
<TID> 3900 <LEN> 0013 <GLEN> <GKEY> <PLEN> <PKEY> <SKEY>
```

### Response

```
<TID> 3900 <LEN> 0013 <DKEY>
```

### Fields

Field        | Length (bytes) | Description
-------------|----------------|------------
`GLEN`       | 2              | The length of the `GKEY` field.
`GKEY`       | `GLEN`         | Radix `g`, constituting a key.
`PLEN`       | 2              | The length of the `PKEY` field.
`PKEY`       | `PLEN`         | Module `p`, constituting the key.
`SKEY`       | variable       | The public key `A`, generated by the server.
`DKEY`       | variable       | The public key `B`, generated by the device.

### Errors

Code   | Description
-------|------------
`0010` | `GLEN`/`PLEN` is too small.
`0011` | `GLEN`/`PLEN` is too big.
`0012` | The shared secret is less than the minimum length.
`0013` | The shared secret is longer than the maximum length.
`0014` | Key exchange algorithm error (calculation error).
